window.WhitekitControl =

  # get cookie
  cookie: (cookie_name)->
    result = document.cookie.match ( '(^|;) ?' + cookie_name + '=([^;]*)(;|$)' )
    if result
      unescape ( result[2] )
    else
      ''
  # set cookie
  cookie_set: (name, value, days = 30)->
    oDate = new Date()
    oDate.setDate(days + oDate.getDate())
    # domain = self.location.host
    document.cookie = name + "=" + value + "; path=/; expires=" + oDate.toGMTString()

  # delete cookie
  cookie_delete: (name)->
    # domain = self.location.host
    document.cookie = name + "=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT"

$(document).ready ->

  # Hover on tools and image
  $('#whitekit-tools, #whitekit-tools a img').hover ->
    if $('#whitekit-tools .whitekit-slide-panel.w-open').hasClass('visible') || $('#whitekit-tools .whitekit-slide-panel.w-close').hasClass('visible')
      $(this).stop().fadeTo(400, 1)
  ,->
    if $('#whitekit-tools .whitekit-slide-panel.w-open').hasClass('visible') || $('#whitekit-tools .whitekit-slide-panel.w-close').hasClass('visible')
      $(this).stop().fadeTo(400, 0.5)

  # Hover on left panel in tools
  $('#whitekit-tools .whitekit-slide-panel').hover ->
    if $(this).hasClass('visible')
      $(this).stop().fadeTo(400, 0.7)
  ,->
    if $(this).hasClass('visible')
      $(this).stop().fadeTo(400, 0.3)

  # Click on the left panel in tools to close panel
  $('#whitekit-tools .whitekit-slide-panel.w-open').click ->
    next = $(this).next();
    if $(this).hasClass('visible')
      next.fadeTo(400, 0.3)
      $(this).removeClass('visible').fadeOut(400).parent().animate {right: '-214px'}, 400, ->
        next.addClass('visible');
        WhitekitControl.cookie_set('whitekit-tools', 'closed')
      $('#whitekit-tools').fadeTo(400, 0.5)

  # Click on the left panel in tools to open panel
  $('#whitekit-tools .whitekit-slide-panel.w-close').click ->
    prev = $(this).prev()
    if $(this).hasClass('visible')
      prev.fadeTo(400, 0.3)
      $(this).removeClass('visible').fadeOut(400).parent().animate {right: 0}, 200, ->
        WhitekitControl.cookie_delete('whitekit-tools')
        prev.addClass('visible')

  # Hover on editable blocks
  $('.white_block, .news').hover ->
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      $(this).addClass('whitekit-hover')
  ,->
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      $(this).removeClass('whitekit-hover')

  # Hover on editable news in block
  $('.white_block .news').hover ->
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      $(this).addClass('whitekit-sub-hover')
  ,->
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      $(this).removeClass('whitekit-sub-hover')

  # Click on editable news
  $('.news').click (e)->
    e.stopPropagation()
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      block = $(this).attr('id')
      id = parseInt(block.split('_').slice(-1)[0])
      document.location.href = "/admin/news/#{id}/edit"

  # Click on editable blocks
  $('.white_block').click ->
    console.log($(this).class);
    edit = WhitekitControl.cookie('whitekit-edit')
    if edit == 'on'
      block = $(this).attr('id')
      id = parseInt(block.split('_').slice(-1)[0])
      document.location.href = "/admin/block/#{id}/edit"

  # Click on edit in tools
  $('#whitekit-tools #whitekit-edit').click (e)->
    e.preventDefault()
    edit = WhitekitControl.cookie('whitekit-edit')
    console.log(edit);
    if edit == 'on'
      WhitekitControl.cookie_delete('whitekit-edit')
      document.location.reload()
    else
      WhitekitControl.cookie_set('whitekit-edit', 'on')
      document.location.reload()

  # Click on clear caches in tools
  $('#whitekit-tools #whitekit-clear-caches').click ->
    $(this).remove()
    $('#whitekit-tools #whitekit-clear-caches-loader').show()

  # Ace editor
  ace_editor = ace.edit('whitekit-editor-code')
  ace_editor.setTheme('ace/theme/monokai')
  ace_editor.getSession().setMode("ace/mode/ruby")
  ace_editor.getSession().setTabSize(2)
  ace_editor.commands.addCommand
    name: 'save'
    bindKey: {win: 'Ctrl-S',  mac: 'Command-S'}
    exec: (editor)->
      alert ace_editor.getValue()
    readOnly: false

  # Click on folder in tree - hide or view children directory
  $(document).on 'click', '#whitekit-site .whitekit-folder', ->
    if $(this).next().hasClass('whitekit-directory')
      # Hide subfolder
      if $(this).next().hasClass('whitekit-directory-opened')
        $(this).next().removeClass('whitekit-directory-opened').hide()
        $('.whitekit-directory', $(this).next()).removeClass('whitekit-directory-opened').hide()
      # Show subfolder
      else
        $(this).next().addClass('whitekit-directory-opened').show()
    else
      # Load subfolder
      unless $(this).hasClass('whitekit-folder-ajax')
        block = $(this)
        block.addClass('whitekit-folder-ajax')
        $.ajax
          url: 'whitekit/get_folder_content'
          type: 'post'
          data: {path: $(this).data('path')}
          success: (data)->
            block.after(data)
            block.next().addClass('whitekit-directory-opened')

  # Click on file in tree - open file for editing
  $(document).on 'click', '#whitekit-site .whitekit-file', ->
    path = $(this).data('path')
    $.ajax
      url: '/whitekit/get_file_content'
      type: 'post'
      dataType: 'json',
      data: {path: path}
      success: (data)->
        ace_editor.getSession().setMode("ace/mode/#{data.type}");
        ace_editor.setValue(data.content)
        ace_editor.gotoLine(1)

  # Hover on the panel to right of editor (for open or close it)
  $('#whitekit-site-move').hover ->
    $(this).stop().fadeTo(400, 1)
  ,->
    $(this).stop().fadeTo(400, 0.2)

  # Click on panel to right of editor (for open or close it)
  $('#whitekit-site-move').click ->
    if $(this).hasClass('opened')
      WhitekitControl.cookie_delete('whitekit-tree')
      $(this).removeClass('opened')
      $('#whitekit-site').animate({left: '-1210px'}, 400)
    else
      # If tree does not exist
      unless $('#whitekit-site .whitekit-directory').size() > 0
        $.ajax
          url: 'whitekit/get_folder_content'
          type: 'post'
          data: {path: '<%= Rails.root.to_s %>'}
          success: (data)->
            $('#whitekit-site').prepend(data)
      WhitekitControl.cookie_set('whitekit-tree', 'opened')
      $(this).addClass('opened')
      $('#whitekit-site').animate({left: '0'}, 400)















